# 镜像加速源

Docker 官方镜像仓库 https://hub.docker.com/



| 镜像加速器          | 镜像加速器地址                          |
| ------------------- | --------------------------------------- |
| Docker 中国官方镜像 | https://registry.docker-cn.com          |
| DaoCloud 镜像站     | http://f1361db2.m.daocloud.io           |
| Azure 中国镜像      | https://dockerhub.azk8s.cn              |
| 科大镜像站          | https://docker.mirrors.ustc.edu.cn      |
| 阿里云              | https://<your_code>.mirror.aliyuncs.com |
| 七牛云              | https://reg-mirror.qiniu.com            |
| 网易云              | https://hub-mirror.c.163.com            |
| 腾讯云              | https://mirror.ccs.tencentyun.com       |



# docker安装redis和wordpress

### 安装redis

```bash
# 安装redis
docker run -d -p 6379:6379 --name redis redis:latest
```

命令参考https://docs.docker.com/engine/reference/commandline/run/



### 安装Wordpress

docker-compose方式安装



wordpress-docker-compose.yml文件如下

```yaml
# 参考 https://docs.docker.com/samples/wordpress/
version: "3.9"
    
services:
  db:
    image: mysql:5.7
    volumes:
      - db_data:/var/lib/mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: somewordpress
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
    
  wordpress:
    depends_on:
      - db
    image: wordpress:latest
    volumes:
      - wordpress_data:/var/www/html
    ports:
      - "8000:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
volumes:
  db_data: {}
  wordpress_data: {}
```

```bash
# 运行
docker-compose -f wordpress-docker-compose.yaml up -d

# 浏览器访问
http://localhost:8000

# 停止 不会清除数据库
docker-compose -f wordpress-docker-compose.yaml down

# 停止 会清除数据库
docker-compose -f wordpress-docker-compose.yaml down --volumes
```



# 制作镜像

以koa-demo项目制作镜像

项目地址 https://github.com/sinkhaha/container-note/tree/main/docker/koa-demo



# 目录挂载

容器产生的数据在容器删除后就丢失了，目录挂载可以解决这个问题



### 几种挂载方式

- bind mount：把宿主机目录映射到容器内（如挂载配置文件）。可挂到多个容器上
- volume(官方推荐)：由容器创建和管理，创建在宿主机，所以删除容器不会丢失，适合存储数据库数据。可挂到多个容器上
- tmpfs mount：适合存储临时文件，存宿主机内存中。不可多容器共享



### 挂载实践

基于上面制作的镜像koa-demo



示例：

```bash
# 使用koa-demo:v1镜像启动一个koa-demo-test的容器 把宿主主机的/mycode/dir目录挂载到容器的/app目录下
docker run -d -p 8080:8080 --name koa-demo-test  -v /mycode/dir:/app koa-demo:v1
```



# 多容器通信

**解决方式：创建虚拟网络**



例子：项目使用一个容器启动，项目中需要连接redis，redis也使用一个容器启动，项目容器需要根redis容器通信

1. 创建一个名为koa-demo-net的网络

```bash
docker network create koa-demo-net
```

2.  启动redis容器，运行于koa-demo-net网络中，别名myredis

```bash
docker run -d --name redis --network koa-demo-net --network-alias myredis redis:latest
```

3. 启动项目容器

```bash
# 使用koa-demo:v1镜像启动容器 nerwork也指定同一个网络
docker run -d -p 8080:8080 --name koa-demo-test  -v /Users/docker-test-volume-dir:/app/log --network koa-demo-net koa-demo:v1
```



# Docker-compose

1. 安装docker-compose

https://docs.docker.com/compose/install/#install-compose-on-linux-systems

2. 编写docker-compose.yaml
3. 在docker-compose.yaml目录下运行 `docker-compose up -d` 启动



# 发布上传镜像

1. docker hub注册账号 https://hub.docker.com/ 

2. 本机命令行登录账号

   ```bash
   docker login -u <用户名>
   ```

3. 新建一个tag，名字必须跟注册账号一样

   ```bash
   docker tag <仓库名>:<tag> <用户名>/<仓库名>:<tag>
   
   # 如 docker tag koa-demo:v1 sinkhaha/koa-demo:v1
   ```

4. 推上去

   ```bash
   docker push <用户名>/<仓库名>:<tag>
   
   # 如 docker push sinkhaha/koa-demo:v1
   ```

5. 拉取镜像，启动容器

   ```bash
   # 以sinkhaha/koa-demo:v1镜像启动容器
   docker run -dp 8080:8080 sinkhaha/koa-demo:v1
   ```

   

# 实践命令

docker命令

```bash
docker ps # 查看当前运行中的容器
docker images # 查看镜像列表
docker rm container-id # 删除指定 id 的容器
docker stop/start container-id # 停止/启动指定 id 的容器
docker rmi image-id # 删除指定 id 的镜像
docker volume ls # 查看 volume 列表
docker network ls # 查看网络列表
```



docker-compose命令

```bash
docker-compose up -d # 运行，-d表示在后台运行
docker-compose ps # 查看运行状态
docker-compose stop # 停止运行
docker-compose restart # 重启
docker-compose restart service-name # 重启单个服务
docker-compose exec service-name sh # 进入容器命令行
docker-compose logs [service-name] # 查看容器运行log
```

